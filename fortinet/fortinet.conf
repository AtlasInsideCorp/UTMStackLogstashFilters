filter {
 #Check the minimum fields present in fortinet log, based in docs and samples provided
 #Were 73 different fields identified, below uses 23 to identify fortinet log
 #In addition we check that "traffic" and "forward" strings are present in message
 
 if ("traffic" in [message] and "forward" in [message] and "devname=" in [message]
 and "date=" in [message] and "time=" in [message] and "logid=" in [message]
 and "type=" in [message] and "subtype=" in [message] and "level=" in [message]
 and "vd=" in [message] and "eventtime=" in [message] and "tz=" in [message]
 and "srcip=" in [message] and "srcintfrole=" in [message] and "dstip=" in [message]
 and "dstintf=" in [message] and "dstintfrole=" in [message] and "sessionid=" in [message]
 and "proto=" in [message] and "action=" in [message] and "policyid=" in [message]
 and "policytype=" in [message] and "service=" in [message] and "trandisp=" in [message]
 and "duration=" in [message]) { 
 
 #First, replace whitespaces after = to avoid kv issues, example:
 #device_id= date=2021-08-18, generates -> device_id="date=2021-08-18"
 #and should generate two fields: device_id and date
      mutate {
        gsub => [
          "message", "= ", "=0 "
        ]
      }
 #Uses the kv filter, usefull in key-value logs
 kv {}
 
 #Generating datasource field
 if ([devname]=="0"){
    mutate {
     add_field => { "dataSource" => "%{host}" }
	}
 }else{
    mutate {
     add_field => { "dataSource" => "%{devname}" }
	}
 }
 
 
 
 #Formatting all possible fields
   mutate {
      add_field => {
       "dataType" => "firewall-fortigate-traffic"
      }
	  rename => {
        "devname" => "[logx][fortigate][devname]"
      }
	  rename => {
        "date" => "[logx][fortigate][date]"
      }
	  rename => {
        "time" => "[logx][fortigate][time]"
      }
	  rename => {
        "logid" => "[logx][fortigate][logid]"
      }
	  rename => {
        "type" => "[logx][fortigate][type]"
      }
	  rename => {
        "subtype" => "[logx][fortigate][subtype]"
      }
	  rename => {
        "level" => "[logx][fortigate][level]"
      }
	  rename => {
        "vd" => "[logx][fortigate][vd]"
      }
	  rename => {
        "eventtime" => "[logx][fortigate][eventtime]"
      }
	  rename => {
        "tz" => "[logx][fortigate][tz]"
      }
	  rename => {
        "srcip" => "[logx][fortigate][src_ip]"
      }
	  rename => {
        "srcport" => "[logx][fortigate][src_port]"
      }
	  rename => {
        "srcintfrole" => "[logx][fortigate][srcintfrole]"
      }
	  rename => {
        "dstip" => "[logx][fortigate][dest_ip]"
      }
	  rename => {
        "dstport" => "[logx][fortigate][dest_port]"
      }
	  rename => {
        "dstintf" => "[logx][fortigate][dstintf]"
      }
	  rename => {
        "dstintfrole" => "[logx][fortigate][dstintfrole]"
      }
	  rename => {
        "sessionid" => "[logx][fortigate][sessionid]"
      }
	  rename => {
        "proto" => "[logx][fortigate][proto]"
      }
	  rename => {
        "action" => "[logx][fortigate][action]"
      }
	  rename => {
        "policyid" => "[logx][fortigate][policyid]"
      }
	  rename => {
        "policytype" => "[logx][fortigate][policytype]"
      }
	  rename => {
        "service" => "[logx][fortigate][service]"
      }
	  rename => {
        "trandisp" => "[logx][fortigate][trandisp]"
      }
	  rename => {
        "duration" => "[logx][fortigate][duration]"
      }
	  rename => {
        "mastersrcmac" => "[logx][fortigate][mastersrcmac]"
      }
	  rename => {
        "srcmac" => "[logx][fortigate][srcmac]"
      }
	  rename => {
        "srcintf" => "[logx][fortigate][srcintf]"
      }
	  rename => {
        "srcname" => "[logx][fortigate][srcname]"
      }
	  rename => {
        "dstcountry" => "[logx][fortigate][dstcountry]"
      }
	  rename => {
        "srccountry" => "[logx][fortigate][srccountry]"
      }
	  rename => {
        "appid" => "[logx][fortigate][appid]"
      }
	  rename => {
        "app" => "[logx][fortigate][app]"
      }
	  rename => {
        "appcat" => "[logx][fortigate][appcat]"
      }
	  rename => {
        "apprisk" => "[logx][fortigate][apprisk]"
      }
	  rename => {
        "applist" => "[logx][fortigate][applist]"
      }
	  rename => {
        "appact" => "[logx][fortigate][appact]"
      }
	  rename => {
        "sentbyte" => "[logx][fortigate][sentbyte]"
      }
	  rename => {
        "rcvdbyte" => "[logx][fortigate][rcvdbyte]"
      }
	  rename => {
        "sentpkt" => "[logx][fortigate][sentpkt]"
      }
	  rename => {
        "rcvdpkt" => "[logx][fortigate][rcvdpkt]"
      }
	  rename => {
        "sentdelta" => "[logx][fortigate][sentdelta]"
      }
	  rename => {
        "rcvddelta" => "[logx][fortigate][rcvddelta]"
      }
	  rename => {
        "osname" => "[logx][fortigate][osname]"
      }
	  rename => {
        "srcswversion" => "[logx][fortigate][srcswversion]"
      }
	  rename => {
        "srchwversion" => "[logx][fortigate][srchwversion]"
      }
	  rename => {
        "srcserver" => "[logx][fortigate][srcserver]"
      }
	  rename => {
        "srchwvendor" => "[logx][fortigate][srchwvendor]"
      }
	  rename => {
        "dsthwvendor" => "[logx][fortigate][dsthwvendor]"
      }
	  rename => {
        "dstosname" => "[logx][fortigate][dstosname]"
      }
	  rename => {
        "dstswversion" => "[logx][fortigate][dstswversion]"
      }
	  rename => {
        "unauthuser" => "[logx][fortigate][unauthuser]"
      }
	  rename => {
        "unauthusersource" => "[logx][fortigate][unauthusersource]"
      }
	  rename => {
        "dstunauthuser" => "[logx][fortigate][dstunauthuser]"
      }
	  rename => {
        "dstunauthusersource" => "[logx][fortigate][dstunauthusersource]"
      }
	  rename => {
        "masterdstmac" => "[logx][fortigate][masterdstmac]"
      }
	  rename => {
        "dstmac" => "[logx][fortigate][dstmac]"
      }
	  rename => {
        "dstserver" => "[logx][fortigate][dstserver]"
      }
	  rename => {
        "device_id" => "[logx][fortigate][device_id]"
      }
	  rename => {
        "transip" => "[logx][fortigate][transip]"
      }
	  rename => {
        "transport" => "[logx][fortigate][transport]"
      }
	  rename => {
        "utmaction" => "[logx][fortigate][utmaction]"
      }
	  rename => {
        "utmref" => "[logx][fortigate][utmref]"
      }
	  rename => {
        "countdns" => "[logx][fortigate][countdns]"
      }
	  rename => {
        "direction" => "[logx][fortigate][direction]"
      }
	  rename => {
        "devtype" => "[logx][fortigate][devtype]"
      }
	  rename => {
        "countapp" => "[logx][fortigate][countapp]"
      }
	  rename => {
        "poluuid" => "[logx][fortigate][poluuid]"
      }
	  rename => {
        "policymode" => "[logx][fortigate][policymode]"
      }
	  rename => {
        "crscore" => "[logx][fortigate][crscore]"
      }
	  rename => {
        "craction" => "[logx][fortigate][craction]"
      }
	  rename => {
        "crlevel" => "[logx][fortigate][crlevel]"
      }
	  rename => {
        "identifier" => "[logx][fortigate][identifier]"
      }
   }
   #Finally, remove unnecessary fields
   mutate {
          remove_field => ["@version","path"]
        }
 }
}