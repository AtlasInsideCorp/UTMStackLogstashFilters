filter {
  #Fields based on https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-system.html (april 2022)
  #https://www.elastic.co/guide/en/beats/filebeat/current/exported-fields-system.html (april 2022)
  #and filebeat fields.yml version 7.13.4 oss
  #As the docs says this module work with one event per line, filebeat must ensure to send one event per line.
  
  #Filebeat system module, version 1.0.0.
  #Filter Input requirements -> fileset: datatype
  #                             syslog: plain text
  #                             auth: plain text
  if [event][module] == "system" or [service][type] == "system" {
    #Generating dataType and dataSource fields
        mutate {
            add_field => { "dataSource" => "%{[host][hostname]}" }
        }
    if [event][module] {
        mutate {
            add_field => { "dataType" => "%{[event][module]}" }
        }
    } else if [service][type] {
        mutate {
            add_field => { "dataType" => "%{[service][type]}" }
        }
    }
    #......................................................................#
    #Then add all possible fields to the json tree structure

        #Fields variants from module
        mutate {
            rename => { "system" => "[logx][system]" }
        }
        mutate { 
        #General fields from ECS
            rename => { "host" => "[logx][system][host]" }
            rename => { "service" => "[logx][system][service]" }
            rename => { "ecs" => "[logx][system][ecs]" }
            rename => { "agent" => "[logx][system][agent]" }
            rename => { "fileset" => "[logx][system][fileset]" }
            rename => { "event" => "[logx][system][event]" }
            rename => { "input" => "[logx][system][input]" }
            rename => { "labels" => "[logx][system][labels]" }
            rename => { "as" => "[logx][system][as]" }
            rename => { "client" => "[logx][system][client]" }
            rename => { "cloud" => "[logx][system][cloud]" }
            rename => { "code_signature" => "[logx][system][code_signature]" }
            rename => { "container" => "[logx][system][container]" }
            rename => { "destination" => "[logx][system][destination]" }
            rename => { "dll" => "[logx][system][dll]" }
            rename => { "dns" => "[logx][system][dns]" }
            rename => { "error" => "[logx][system][error]" }
            rename => { "file" => "[logx][system][file]" }
            rename => { "geo" => "[logx][system][geo]" }
            rename => { "hash" => "[logx][system][hash]" }
            rename => { "http" => "[logx][system][http]" }
            rename => { "interface" => "[logx][system][interface]" }
            rename => { "network" => "[logx][system][network]" }
            rename => { "observer" => "[logx][system][observer]" }
            rename => { "organization" => "[logx][system][organization]" }
            rename => { "package" => "[logx][system][package]" }
            rename => { "pe" => "[logx][system][pe]" }
            rename => { "process" => "[logx][system][process]" }
            rename => { "registry" => "[logx][system][registry]" }
            rename => { "related" => "[logx][system][related]" }
            rename => { "rule" => "[logx][system][rule]" }
            rename => { "server" => "[logx][system][server]" }
            rename => { "source" => "[logx][system][source]" }
            rename => { "threat" => "[logx][system][threat]" }
            rename => { "tls" => "[logx][system][tls]" }
            rename => { "span.id" => "[logx][system][span.id]" }
            rename => { "trace.id" => "[logx][system][trace.id]" }
            rename => { "transaction.id" => "[logx][system][transaction.id]" }
            rename => { "url" => "[logx][system][url]" }
            rename => { "user" => "[logx][system][user]" }
            rename => { "vlan" => "[logx][system][vlan]" }
            rename => { "vulnerability" => "[logx][system][vulnerability]" }
            rename => { "x509" => "[logx][system][x509]" }

            #Rename message field to add it to the structure
            rename => { "message" => "[logx][system][message]" }

        }
        #......................................................................#
        #Finally, remove unnecessary fields
        mutate {
            remove_field => ["@version","tags","log"]
        }
  }
}
